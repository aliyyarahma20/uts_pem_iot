<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Riwayat Data - IoT Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="fade-in">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
        <span>IoT Dashboard</span>
      </a>

      <div class="nav-links">
        <a href="index.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          Dashboard
        </a>
        <a href="monitoring.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          Monitoring
        </a>
        <a href="analysis.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
          Analisis
        </a>
        <a href="history.html" class="active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          Riwayat
        </a>
        <a href="hydro.html">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 24V11.2M12 12V16.8M12 12C12 8.46538 9.41462 5.6 6.2 5.6H0.8V10.4C0.8 13.9346 3.38538 16.8 6.8 16.8H12M12 12H16.8C20.3346 12 23.2 9.41462 23.2 5.6V0.8H18.4C14.8654 0.8 12 3.38538 12 7.2V12ZM12 12L18.4 5.6M12 16.8L6.2 10.4"/>
          </svg>
          Hidroponik
        </a>
      </div>

      <button class="theme-toggle" id="themeToggle">
        <svg id="sunIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg id="moonIcon" style="display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <h1>Riwayat Data Sensor</h1>
    <p>Telusuri dan cari data sensor historis</p>
  </header>

  <!-- Main Content -->
  <main class="container">
    <div class="card">
      <div class="card-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <h2>Pencarian Data</h2>
      </div>

      <div class="search-wrapper">
        <input
          type="text"
          id="searchBox"
          class="search-box"
          placeholder="Cari berdasarkan ID atau tanggal..."
        />
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 7h16M4 12h16M4 17h16"/>
        </svg>
        <h2>Semua Data Sensor</h2>
      </div>
      <div class="table-container">
        <table id="historyTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Suhu (Â°C)</th>
              <th>Kelembapan (%)</th>
              <th>Kecerahan (Lux)</th>
              <th>Waktu</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="loading">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="script.js"></script>
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const url = "http://localhost:8000/api/all-sensor";
    const tbody = document.querySelector("#historyTable tbody");
    const searchBox = document.getElementById("searchBox");

    async function loadHistory() {
      try {
        const res = await fetch(url);
        const data = await res.json();

        // ambil semua data dari backend
        const rows = data.all_data || [];

        const render = (arr) => {
          tbody.innerHTML = "";
          if (arr.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="loading">Tidak ada data yang cocok</td></tr>`;
            return;
          }
          arr.forEach(r => {
            tbody.innerHTML += `
              <tr>
                <td>${r.id}</td>
                <td>${r.suhu}</td>
                <td>${r.humidity}</td>
                <td>${r.lux}</td>
                <td>${new Date(r.timestamp).toLocaleString()}</td>
              </tr>`;
          });
        };

        // render awal
        render(rows);

        // fitur pencarian realtime
        searchBox.addEventListener("input", e => {
          const q = e.target.value.toLowerCase();
          const filtered = rows.filter(r =>
            r.id.toString().includes(q) ||
            new Date(r.timestamp).toLocaleString().toLowerCase().includes(q)
          );
          render(filtered);
        });
      } catch (err) {
        console.error("Gagal memuat riwayat:", err);
        tbody.innerHTML = `<tr><td colspan="5" class="loading">Gagal memuat data</td></tr>`;
      }
    }

    await loadHistory();
  });
  </script>

</body>
</html>